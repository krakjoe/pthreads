<!DOCTYPE html>
<!--[if lt IE 7 ]> <html lang="en" class="ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" > <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta property="og:title" content="pthreads - Share Nothing, Do Everything :)" />
<meta property="og:url" content="http://pthreads.org" />
<meta property="og:type" content="website" />
<meta property="og:image" content="../images/pthreads-logo.png" />
<title>Share Nothing, Do Everything :) - Recycling Contexts</title>	
<meta name="robots" content="index, follow"> 
<link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
<link href="../css/reset.css" rel="stylesheet">
<link href="../css/stylesheet.css" rel="stylesheet">
<script type="text/javascript" src="../js/shCore.js"></script>
<script type="text/javascript" src="../js/shBrushPhp.js"></script>
<link type="text/css" rel="stylesheet" href="../css/shCoreDefault.css"/>
<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]--> 
<!--[if lt IE 7 ]>
	<script src="../js/dd_belatedpng.js"></script>
	<script> DD_belatedPNG.fix('img, .png_bg'); //fix any <img> or .png_bg background-images </script>
<![endif]-->
<meta name="description" content="pthreads.org - Share Nothing, Do Everything :)" />
<meta name="keywords" content="thread php, multi thread php, php workers, asynchronous php, pthreads tutorial" />
<link rel="canonical" href="http://pthreads.org/" />
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34980052-1']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  SyntaxHighlighter.all();
</script>
</head> 
<body id="index" >
	<!-- site header -->
	<header>
		<div class="header">
			<div class="wrapper"> 
				<!-- logo/sitename -->
				<a href="http://pthreads.org/" id="logo" ><img src="../images/pthreads-logo.png" alt="pthreads.org" border="0px"/></a>
				
			</div>
		</div>
  </header>	
	<div class="wrapper clearfix">
		<!-- page content -->
		<article>
			<section>
				<!-- title and content -->
				<h1>Recycling Contexts</h1>
				<p>In line with our mantra, always consider employing the Worker and Stackable model of execution.</p>
				<p>The Worker model allows a context (Thread) to be reused, so if many tasks need to be executed asynchronously to the process (or creating Thread), but those tasks themselves are suitable to be executed synchronously then using a single context rather than many is a huge win.</p>
                <h2>Worker and Stackable Brief</h2>
                <p>The patterns used to create Workers and Stackable are much the same as those used to create Threads. </p>
                <pre class="brush: php">
                class WebWorker extends Worker {
                    public function run(){}
                }
                
                class WebRequest extends Stackable {
                    public $url;
                    public $data;
                    
                    public function __construct($url) {
                        $this->url = $url;
                    }
                    
                    public function run() {
                        $response = file_get_contents($this->url);
                        
                        if ($response) {
                            /* process response */
                            
                            $this->data = array($response);
                        }
                    }
                }
                
                $worker = new WebWorker();
                $worker->start();
                
                $work = array();
                
                /* create some random work */
                foreach (range(0, 10) as $index) {
                    /* retain reference to the work */
                    $work[$index] = new WebRequest(
                        "http://pthreads.org/?query={$index}");
                        
                    /* stack the work for execution */
                    $worker->stack($work[$index]);
                }
                
                /* shutting down waits for the execution of 
                    anything previously stacked, then joins the Worker */
                $worker->shutdown();
                
                foreach ($work as $task) {
                    var_dump ($task->data);
                }
                </pre>
                <p>In the example above, many requests are processed by the same context. The aim should be to always use Workers and Stackables wherever possible, it is much more efficient to create one context (Worker), rather than many contexts (Threads).</p>
                <h2>Asynchronous Logging</h2>
                <p>A good example of using Workers in the real world might be an implementation of asynchronous logging.</p>
                <p>In the real world, an asynchronous logger would be much more complex than the following example, for the purposes of a tutorial we will just write logs to standard output.</p>
                <pre class="brush: php">
				class LogEntry extends Stackable {
					public $message;
					public $args;
					 
					public function __construct($message, $args = null) {
						$this->message = $message;
						$this->args = $args;
					}
					 
					public function run() {
						/* for simplicity */
						vprintf(
							"{$this->message}\n", $this->args);
					}
				}
				 
				class Logger extends Worker {
					static $instance = null;
					static $work = [];
		
					public function __construct() {
						$this->start();
					}
					 
					public static function log($message, $args = null) {
						if (self::$instance == null) {
							self::$instance = new Logger();
						}
				
						$args = func_get_args();
						if ($args) {
							$wid = count(self::$work);
							self::$work[$wid]=new LogEntry(
								array_shift($args),
								$args
							);
							self::$instance->stack(self::$work[$wid]);
						}
					}
					 
					public function run() {}
				}
				Logger::log("Hello %s", "World");
				Logger::log("Bye :)");
                </pre>
                <p>In the example above, it is the Worker that actually performs the writing of logs - however that is performed.</p>
				<!-- page footer -->
				<div class="footer">
					<p>Published on <time datetime="2013-05-12" pubdate>May 12th, 2013</time></p>
				</div>
			</section>
			
		</article>
		
		<!-- include the sidebar template -->
<aside id="sidebar">
	<!-- wrap each sidebar section like this -->
	<div class="section">
		<h2>Highlights</h2>
<ul> 
<li>Easy to use Threading API for PHP5.3+</li> 
<li>Execute <span style="font-weight: bold;">anything</span> asynchronously</li> 
<li>Easy Synchronization Included</li> 
<li>SAPI Support</li> 
<li>A world of possibilities ...</li> 
</ul>
<h2>Technical Features</h2>
<ul>
<li>Posix Threading</li>
<li>Synchronization</li>
<li>Worker Threads</li>
<li>Mutex</li>
<li>Condition Variables</li>
</ul>
<h2>Requirements</h2>
<ul>
<li>PHP5.3+ on x64 or x86</li>
<li>ZTS Enabled ( Thread Safety )</li>
<li>Posix Threads implementation<span style="font-weight:bold;">*</span></li>
<li style="list-style-type:none;">
<small><span style="font-weight:bold;">*</span>Windows support thanks to <a href="http://sources.redhat.com/pthreads-win32">pthread-w32</a></small>
</li>
</ul>
<h2>Documentation</h2>
<ul>
  <li><a href="http://docs.php.net/manual/en/book.pthreads">See the PHP Manual</a></li>
</ul>
<h2>Implementation</h2>
<ul>
  <li><a href="start.html">Getting Started</a></li>
  <li><a href="recycle.html">Recycling Contexts</a></li>
</ul>
<h2>Downloads</h2>
<ul>
 <li><a href="http://pecl.php.net/package/pthreads" target="_blank">PECL</a></li>
 <li><a href="https://github.com/krakjoe/pthreads" target="_blank">Github</a></li>
 <li><a href="http://windows.php.net/downloads/pecl/releases/pthreads/" target="_blank">Windows Binaries</a></li>
</ul>	
</div>
</aside>	
</div>

<!-- include the footer template -->

	<!-- site footer -->
	<footer class="clearfix" >
		
			 	<div class="wrapper">
			<div class="left"><a href="http://pthreads.org/" >pthreads.org</a>&nbsp;&copy;&nbsp;2013</div>
			<div class="right"><a href="http://php.net/"><img src="../images/php-powered.png" alt="PHP5 Powered" target="_blank"></a></div>
		</div>
	</footer>
	
</body>
</html>
